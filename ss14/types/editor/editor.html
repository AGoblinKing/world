<polymer-element name="game-editor" extends="three-object3d" attributes="uuid">
    <template>
        <style>
            @host { width: 100%; height: 100%; display: block; }
            
            #toolbar {
                width: 100%;
                top: 0px;
                left: 0px;
                z-index: 5;
                position: absolute;
            }
            
            #bottomToolbar {
                bottom: 0px;
                left: 0px;
                width: 100%;
                position: absolute;
                z-index: 5;
            }
            .position {
                color: white;
                text-shadow: 0px 0px 2px black;   
            }
            .target {
                color: red;   
            }
        </style>
        <div id="toolbar">
            <button click="onEdit">Edit Mode</button>
        </div>
        <div id="bottomToolbar" flexbox>
            <div class="position" flex>{{selected.position.x}},{{selected.position.z}}</div>
            <div class="position target" flex>{{selection.position.x}},{{selection.position.z}}</div>
        </div>
    </template>
    <script>
        Polymer("game-editor", {
            onEdit: function() {
                
            },
            ready: function() {
                this.data = Game.state[this.uuid];
                this.super();
                this.wall = THREE.SceneUtils.createMultiMaterialObject(new THREE.CubeGeometry(1,1,1), [ new THREE.MeshBasicMaterial({color: 0xFFFFFF}), new THREE.MeshBasicMaterial({color:0x000000, wireframe: true})]);
                
                this.selection = new THREE.Mesh(new THREE.PlaneGeometry(1,1), new THREE.MeshBasicMaterial({color: 0xFF0000, emissive: 0xFF0000, transparent: true, opacity: .5}));
                this.selection.rotation.x = -(90 * Math.PI/180);
                this.selected = this.selection.clone();
                this.selected.material = new THREE.MeshBasicMaterial({color: 0x00FF00, transparent: true, opactiy: .5});
                
                this.three.add(this.selection);
                this.three.add(this.selected);
                this.walls = {};
                var projector = new THREE.Projector();
                Game.target.addEventListener("mousemove", function(event) {
                    var vector = new THREE.Vector3(
                        ( event.clientX / window.innerWidth ) * 2 - 1,
                        - ( event.clientY / window.innerHeight ) * 2 + 1,
                        0.5 ),
                        camera = Game.camera;
                    
                    projector.unprojectVector( vector, camera );
                    
                    var dir = vector.sub( camera.position ).normalize();
                    var pos = camera.position.clone().add( dir.multiplyScalar( - camera.position.y / dir.y ) );
                    pos.x = Math.round(pos.x);
                    pos.y = Math.round(pos.y);
                    pos.z = Math.round(pos.z);
                    
                    this.selection.position = pos;
                }.bind(this));
                
                Game.target.addEventListener("mousedown", function(event) {
                    var posKey = this.selection.position.x+":"+this.selection.position.z;
                    this.selected.position.copy(this.selection.position);
                    var newWall = this.wall.clone();
                    
                    if(!this.walls[posKey] && event.which !== 3) { 
                        newWall.position.copy(this.selection.position);
                        newWall.position.y += .5;
                        this.walls[posKey] = newWall;
                        this.three.add(newWall);
                    } else if(event.which === 3) {
                        console.log("removing", posKey);
                        this.three.remove(this.walls[posKey]);
                        delete this.walls[posKey];
                    }
                    console.log(posKey, this.walls);
                    event.preventDefault();
                }.bind(this));
                
                Game.target.addEventListener("contextmenu", function(event) { event.preventDefault()});
            }
        });
    </script>
</polymer-element>w